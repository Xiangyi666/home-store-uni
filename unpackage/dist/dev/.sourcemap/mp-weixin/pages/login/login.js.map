{"version":3,"file":"login.js","sources":["pages/login/login.vue","pages/login/login.vue?type=page"],"sourcesContent":["<template>\n    <view class=\"login-container\">\n        <button @click=\"wechatLogin\" type=\"primary\">微信一键登录</button>\n    </view>\n</template>\n\n<script>\nimport http from '@/utils/http.js';\n\nexport default {\n\t\tdata() {\n\t\t\treturn {\n\t\t\t\tdev: true,\n\t\t\t}\n\t\t},\n\t\tmounted() {\n\t\t\t// this.wechatLogin()\n\t\t},\n    methods: {\n    // 检查用户是否注册\n     async checkUserRegistered (openid){\n        try {\n            const response = await http.get(`/users/wechat/check?openid=${encodeURIComponent(openid)}`);\n            return response;\n        } catch (error) {\n            console.error('检查用户失败:', error);\n            throw error;\n        }\n    },\n    \n    // 完整的登录流程\n    async wechatLogin() {\n    try {\n\t\t\t\tlet openidResult = null;\n\t\t\t\tif(!this.dev) {\n\t\t\t\t\t// 1. 获取微信 code\n\t\t\t\t\tconst loginRes = await new Promise((resolve, reject) => {\n\t\t\t\t\t    uni.login({\n\t\t\t\t\t        provider: 'weixin',\n\t\t\t\t\t        success: resolve,\n\t\t\t\t\t        fail: reject\n\t\t\t\t\t    });\n\t\t\t\t\t});\n\t\t\t\t\tconsole.log('loginRes--', loginRes)\n\t\t\t\t\t// 2. 用 code 换取 openid（调用后端接口）\n\t\t\t\t\t openidResult = await http.post('/users/wechat/get-openid', {\n\t\t\t\t\t    code: loginRes.code\n\t\t\t\t\t});\n\t\t\t\t}\n       \n        openidResult = {openid: 'test_openid_123'}\n        const openid = openidResult.openid;\n\n        // 3. 检查用户是否已注册\n        const checkResult = await this.checkUserRegistered(openid);\n        \n        if (checkResult.registered) {\n            // 已注册用户 - 直接登录\n            const loginResult = await http.post('/users/wechat/login-by-openid', {\n                openid: openid\n            });\n            \n            // 保存 token 和用户信息\n            uni.setStorageSync('token', loginResult.token);\n            uni.setStorageSync('user', loginResult.user);\n            \n            uni.showToast({ title: '登录成功', icon: 'success' });\n            \n        } else {\n            // 新用户 - 需要获取用户信息并注册\n            uni.showModal({\n                title: '提示',\n                content: '欢迎新用户，请授权个人信息完成注册',\n                showCancel: false,\n                success: async () => {\n                    // 获取用户信息\n                    const userInfo = await new Promise((resolve, reject) => {\n                        uni.getUserProfile({\n                            desc: '用于完善会员资料',\n                            success: resolve,\n                            fail: reject\n                        });\n                    });\n                    \n                    // 注册新用户\n                    const registerResult = await http.post('/users/wechat/register', {\n                        openid: openid,\n                        nickname: userInfo.userInfo.nickName,\n                        avatarUrl: userInfo.userInfo.avatarUrl\n                    });\n                    \n                    // 保存 token 和用户信息\n                    uni.setStorageSync('token', registerResult.token);\n                    uni.setStorageSync('user', registerResult.user);\n                    \n                    uni.showToast({ title: '注册成功', icon: 'success' });\n                }\n            });\n        }\n        \n    } catch (error) {\n        console.error('登录流程失败:', error);\n        uni.showToast({ title: '登录失败', icon: 'none' });\n    }\n}\n    }\n}\n</script>","import MiniProgramPage from '/Users/amh/Documents/HBuilderProjects/home-store-uni/pages/login/login.vue'\nwx.createPage(MiniProgramPage)"],"names":["http","uni"],"mappings":";;;AASA,MAAK,YAAU;AAAA,EACb,OAAO;AACN,WAAO;AAAA,MACN,KAAK;AAAA,IACN;AAAA,EACA;AAAA,EACD,UAAU;AAAA,EAET;AAAA,EACC,SAAS;AAAA;AAAA,IAER,MAAM,oBAAqB,QAAO;AAC/B,UAAI;AACA,cAAM,WAAW,MAAMA,WAAI,KAAC,IAAI,8BAA8B,mBAAmB,MAAM,CAAC,EAAE;AAC1F,eAAO;AAAA,MACT,SAAO,OAAO;AACZC,sBAAA,MAAA,MAAA,SAAA,+BAAc,WAAW,KAAK;AAC9B,cAAM;AAAA,MACV;AAAA,IACH;AAAA;AAAA,IAGD,MAAM,cAAc;AACpB,UAAI;AACJ,YAAI,eAAe;AACnB,YAAG,CAAC,KAAK,KAAK;AAEb,gBAAM,WAAW,MAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACpDA,0BAAAA,MAAI,MAAM;AAAA,cACN,UAAU;AAAA,cACV,SAAS;AAAA,cACT,MAAM;AAAA,YACV,CAAC;AAAA,UACL,CAAC;AACDA,wBAAAA,MAAA,MAAA,OAAA,+BAAY,cAAc,QAAQ;AAEjC,yBAAe,MAAMD,WAAAA,KAAK,KAAK,4BAA4B;AAAA,YACxD,MAAM,SAAS;AAAA,UACnB,CAAC;AAAA,QACF;AAEI,uBAAe,EAAC,QAAQ,kBAAiB;AACzC,cAAM,SAAS,aAAa;AAG5B,cAAM,cAAc,MAAM,KAAK,oBAAoB,MAAM;AAEzD,YAAI,YAAY,YAAY;AAExB,gBAAM,cAAc,MAAMA,gBAAK,KAAK,iCAAiC;AAAA,YACjE;AAAA,UACJ,CAAC;AAGDC,wBAAAA,MAAI,eAAe,SAAS,YAAY,KAAK;AAC7CA,wBAAAA,MAAI,eAAe,QAAQ,YAAY,IAAI;AAE3CA,wBAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,UAAQ,CAAG;AAAA,eAE7C;AAEHA,wBAAAA,MAAI,UAAU;AAAA,YACV,OAAO;AAAA,YACP,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,SAAS,YAAY;AAEjB,oBAAM,WAAW,MAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACpDA,8BAAAA,MAAI,eAAe;AAAA,kBACf,MAAM;AAAA,kBACN,SAAS;AAAA,kBACT,MAAM;AAAA,gBACV,CAAC;AAAA,cACL,CAAC;AAGD,oBAAM,iBAAiB,MAAMD,gBAAK,KAAK,0BAA0B;AAAA,gBAC7D;AAAA,gBACA,UAAU,SAAS,SAAS;AAAA,gBAC5B,WAAW,SAAS,SAAS;AAAA,cACjC,CAAC;AAGDC,4BAAAA,MAAI,eAAe,SAAS,eAAe,KAAK;AAChDA,4BAAAA,MAAI,eAAe,QAAQ,eAAe,IAAI;AAE9CA,4BAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,UAAQ,CAAG;AAAA,YACpD;AAAA,UACJ,CAAC;AAAA,QACL;AAAA,MAEF,SAAO,OAAO;AACZA,sBAAA,MAAA,MAAA,SAAA,gCAAc,WAAW,KAAK;AAC9BA,sBAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,OAAK,CAAG;AAAA,MACjD;AAAA,IACJ;AAAA,EACI;AACJ;;;;;;;ACzGA,GAAG,WAAW,eAAe;"}